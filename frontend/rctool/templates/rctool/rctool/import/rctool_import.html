{% extends 'rctool/base.html' %}
{% load static %}


{% block content %}
<div class="container-fluid mt-2">
    <div class="tab-bar-container">
        <ul class="tab-bar-list">
            <li class="tab-bar-item-current"><a href="{% url 'rctool_import' 0 %}">import</a></li>
            <li class="tab-bar-item" style="pointer-events: none;"><a href="#">develop</a></li>
            <li class="tab-bar-item" style="pointer-events: none;"><a href="#">export</a></li>
        </ul>
    </div>

    <div style="background-color: #FFFFFF; padding-left:10px; padding-right:10px;">
        <div class="row justify-content-md-center" style="padding: 20px;">
            <div class="card">
                <h6 class="card-header text-center" style="background-color: #758fa8; color: #FFFFFF; height:30px; font-size:12.5px; padding-top:7px;">Import Data</h6>
                <div class="card-body pt-3" style="display: flex;">
                    <div class="row">
                        <div class="card-body-left col-lg-5 col-md-12">

                            <form action="{% url 'rctool_develop_initialize' %}" method="post">
                                <div class="form-group" style="margin-bottom:25px;font-size:11.5px;">
                                    {% csrf_token %}

                                    <div>
                                    <label class="form-label">session type</label><br>
                                        {{form.input_session_type}}
                                    </div>
                                    
                                    <div style="margin-top:15px;">
                                        <label class="form-label">header row number</label>
                                        {{form.header_row}}
                                    </div>
                                    
                                    <div style="margin-top:15px;">
                                        <label class="form-label">csv separator</label>
                                        {{form.csv_separator}}
                                    </div>

                                    <div style="margin-top:15px;">
                                        <input type="file" id="csvFile" accept=".csv"/>
                                        <br/>
                                        <small class="text-small">
                                            *csv format only, download sample file here: <a href="{% static 'sample_data/sample_data.csv' %}" download>sample_data.csv</a>. Separator: comma, Header row: 1
                                        </small>
                                    </div>


                                    <input type="hidden" id="csv_content" name="csv_content" value="">
                                </div>
                                
                                <button class="btn btn-primary btn-block" style="background-color: #6c747e !important; border-color: #FFFFFF;" type="submit"  id="enter-data-button"><small>submit</small></button>
                            </form>
                        </div>

                        <div class="card-body-right col-lg-7 col-md-12">
                            <p id="input-instructions" style="font-size:11.5px;">
                                Please upload in csv format with the specific column names and format specified below.
                            </p>
                            
                            <div id="csv-data-table" style="display: flex; margin-top:15px;">
                                <table class="table">
                                    <tr class="table-header">
                                        <th class="table-cell">datetime</th>
                                        <th class="table-cell">discharge</th>
                                        <th class="table-cell">stage</th>
                                        <th class="table-cell">uncertainty</th>
                                        <th class="table-cell">comments</th>
                                    </tr>
                                    <tr class="table-row">
                                        <td class="table-cell">YYYY-MM-DD HH:MM</td>
                                        <td class="table-cell">number</td>
                                        <td class="table-cell">number</td>
                                        <td class="table-cell">decimal fraction (optional)</td>
                                        <td class="table-cell">text (optional)</td>
                                    </tr>
                                </table>
                            </div>

                            <small class="text-small">
                                If no uncertainty data is provided, missing values will be filled in as 0.05 (5%).
                             </small>
                            <div id="error-messages">
                                {% if messages %}
                                    {% for message in messages %}
                                        <div>
                                            <strong class="error-text">{{message|safe}}</strong>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>

// IMPORT FUNCTIONS
function toggleInputForm(toggleFormVal) {
    var toggleDiv = document.getElementById("toggle-div");
        if (toggleFormVal === "new-session") {
            document.getElementById('example-data').style.display = "block";
            toggleDiv.style.display = "block";
            document.getElementById("input-instructions").innerHTML = "Please upload in csv format with column names; 'datetime', 'discharge', 'stage', 'uncertainty', and 'comments'"
        } else {
            toggleDiv.style.display = "none";
            document.getElementById('example-data').style.display = "none";
            document.getElementById("input-instructions").innerHTML = "Please upload .dat file from previous session."
            document.getElementById("import-data-form").action = '../../develop/initialize'
    };
};

// INITIALIZATION MESSAGE
// Initialize display message recommending to set offset before autofitting upon initialization of develop page
if (sessionStorage.getItem("developStartupMessage") == null) {
        sessionStorage.setItem("developStartupMessage", true);
};


// APP WALKTHROUGH
// Check if tour status has been previously set
if (sessionStorage.getItem("tourStatus") == null) {
    // Check if user selected tour
    var tourStatusID = {{ tour_request_status_id|safe }};
    if (tourStatusID == 1) {
        sessionStorage.setItem("tourStatus", true);
    } else {
            sessionStorage.setItem("tourStatus", false);
            }
    };
        
// configure tour steps
var importTour = new Tour({
    onEnd: function (tour) {
        sessionStorage.setItem("tourStatus", false);
        },
    steps: [
            {
            element: "#input-session-type",
            title: "Import Walkthrough",
            content: "To begin, a previous session or data for a new session can be uploaded. This step can be skipped for this tour since a sample dataset has already been uploaded."
            },
            {
            element: "#form-header-row",
            title: "Import Walkthrough",
            content: "Field data can be uploaded using a csv file with example column names specified on the right. When importing data, select which row has these column headings by adjusting the header.  If uncertainty data is uploaded, missing values will be filled in as 0.05 (5%)."
            },
            {
            element: "#enter-data-button",
            title: "Import Walkthrough",
            content: "To continue this tour with the sample data, please select load, then next"
            }
        ]
});
        
if (sessionStorage.getItem("tourStatus") == 'true') {
    importTour.init();
    importTour.start(sessionStorage.getItem("tourStatus"));
    importTour.restart();
};

function loadCSV() {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split("\n");
        const result = [];
        const headerRow = document.getElementById("form-header-row").value - 1;
        const separator = document.getElementById("id_csv_separator").value;

        console.log(separator)

        const headers = lines[headerRow].replace(/\r/g, "").split(separator);
        console.log(headers)

        for (let i = headerRow + 1; i < lines.length; i++) {
            const obj = {};

            const values = [];
            const line = lines[i].replace(/\r/g, "");
            let currentValue = '';
            let insideQuotes = false;

            for (let j = 0; j < line.length; j++) {
                const char = line[j];

                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === separator && !insideQuotes) {
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }

            // Add the last value (outside the loop)
            values.push(currentValue.trim());

            for (let col = 0; col < headers.length; col++) {
                if (values[col] === "" || values[col] === undefined) {
                    continue;
                }
                obj[headers[col]] = values[col]
            }

            // skip empty rows
            if (obj["datetime"] === undefined || obj["datetime"] === "") {
                continue;
            }

            // filter out leading and trailing quotes replace internal comma and tab
            for (let key in obj) {
                obj[key] = obj[key].replace(/^"|"$/g, "").replace(/,/g, ";").replace(/\t/g, ";");
            }

            console.log(obj)
            result.push(obj);
        }

        // set the csv content to the hidden form field
        document.getElementById("csv_content").value = JSON.stringify(result);

    };
    reader.readAsText(document.getElementById("csvFile").files[0]);
};


function updateTable() {
    textData = document.getElementById("csv_content").value;

    try {
        result = JSON.parse(textData);
        headers = Object.keys(result[0]);
    } catch (e) {
        console.log(e);
        clearTable();
        return;
    }


    // show the table in csv-data-table
    const table = document.getElementById("csv-data-table").getElementsByTagName("table")[0];
    table.innerHTML = "";
    const headerRow = table.insertRow();
    for (let header of headers) {
        const cell = headerRow.insertCell();
        cell.textContent = header;
        cell.classList.add("table-cell");
    }
    for (let row of result) {
        const tableRow = table.insertRow();
        for (let header of headers) {
            const cell = tableRow.insertCell();
            cell.textContent = row[header];
            cell.classList.add("table-cell");
        }
    }

    // hide input-instructions
    document.getElementById("input-instructions").style.display = "none";
}


function clearTable(){
    const table = document.getElementById("csv-data-table").getElementsByTagName("table")[0];
    table.innerHTML = `
    <tr class="table-header">
        <th class="table-cell">datetime</th>
        <th class="table-cell">discharge</th>
        <th class="table-cell">stage</th>
        <th class="table-cell">uncertainty</th>
        <th class="table-cell">comments</th>
    </tr>
    <tr class="table-row">
        <td class="table-cell">YYYY-MM-DD HH:MM</td>
        <td class="table-cell">number</td>
        <td class="table-cell">number</td>
        <td class="table-cell">decimal fraction (optional)</td>
        <td class="table-cell">text (optional)</td>
    </tr>
    `;
}
function refreshTable() {
    clearTable();
    try {
        loadCSV();
        setTimeout(updateTable, 200);
        updateTable();
    } catch (e) {
        console.log(e);
        clearTable();
    }
}

// on input field change, update the table
document.getElementById("csvFile").addEventListener("change", refreshTable);
document.getElementById("id_csv_separator").addEventListener("change", refreshTable);
document.getElementById("id_csv_separator").addEventListener("change", refreshTable);
document.getElementById("form-header-row").addEventListener("change", refreshTable);

// on first load, update the table
refreshTable()

</script>
{% endblock %}